<!DOCTYPE html>
<html>
  <body>
    <input type="text" name="token" id="token" />
    <button onclick="runTest()">Test</button><br/>
    <span id="starturl"></span><br/>
    <span>v20</span><br/>
    <span id="isChrome"></span><br/>
    <span id="userAgent"></span>
  </body>
  <script>
    const isChrome = ((/CriOS/i.test(navigator.userAgent) && /iphone|ipod|ipad/i.test(navigator.userAgent)) ||Â /Chrome/i.test(navigator.userAgent));
    document.getElementById('isChrome').innerHTML = 'isChrome?' + isChrome.toString();
    document.getElementById('userAgent').innerHTML = navigator.userAgent;
    
    function runTest() {
      let redirectUrl = window.location.href;
      // redirectUrl = isChrome ? redirectUrl.replace('http', 'googlechrome') : redirectUrl; // will be correct for https
      
      // const encodedRedirectUrl = encodeURIComponent(redirectUrl).replace(/%([0-9])([A-Z])/g, function(match, p1, p2) {
      //   return '%' + p1 + p2.toLowerCase();
      // });
      const encodedRedirectUrl = encodeRedirectUrl(true, false);
      
      const autostartToken = document.getElementById('token').value;
      let starturl = 'bankid:///?autostarttoken=' + autostartToken + '&redirect=' + encodedRedirectUrl;
      starturl += (navigator.userAgent.match(/(iPod|iPhone|iPad)/) && navigator.userAgent.match(/AppleWebKit/)) ? '#bankid' : '';
      document.getElementById('starturl').innerHTML = starturl;
      
      window.location = starturl;
    }
    
    function encodeRedirectUrl(n, t) {
          if (!n) return "null";
      
            var a = window.navigator.userAgent
              , r = window.location
              , l = r.href
              , i = r.pathname
              , o = r.protocol;
            return t ? i : a.includes("CriOS") ? encodeURIComponent(l.replace('http', 'googlechrome://http')) : a.includes("FxiOS") ? encodeURIComponent("firefox://" + l.replace(o, "")) : encodeURIComponent(l)
    }
  </script>
</html>
